<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Complete Gateway Workflow</title>
    <style>
        body {
            font-family: monospace;
            padding: 20px;
            background: #000;
            color: #0f0;
        }
        button {
            padding: 10px 20px;
            background: #333;
            color: #0f0;
            border: 1px solid #0f0;
            cursor: pointer;
            margin: 10px;
        }
        button:hover {
            background: #444;
        }
        #output {
            margin-top: 20px;
            padding: 20px;
            border: 1px solid #0f0;
            height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <h1>Gateway zkML Workflow Test with Real Signing</h1>
    
    <button onclick="testWorkflow()">Run Complete Workflow</button>
    <button onclick="clearOutput()">Clear</button>
    
    <div id="output"></div>
    
    <!-- Load ethers -->
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    
    <script>
        function log(msg) {
            const output = document.getElementById('output');
            output.textContent += msg + '\n';
            output.scrollTop = output.scrollHeight;
        }
        
        function clearOutput() {
            document.getElementById('output').textContent = '';
        }
        
        async function testWorkflow() {
            log('===========================================');
            log('   COMPLETE GATEWAY zkML WORKFLOW TEST');
            log('===========================================\n');
            
            // Step 1: zkML Proof
            log('STEP 1: Generating zkML proof...');
            try {
                const proofResp = await fetch('http://localhost:8002/zkml/prove', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        input: {
                            is_financial_agent: 1,
                            amount: 100,
                            is_gateway_op: 1,
                            risk_score: 20,
                            confidence_score: 95,
                            authorization_level: 3,
                            compliance_check: 1,
                            fraud_detection_score: 15,
                            transaction_velocity: 5,
                            account_reputation: 90,
                            geo_risk_factor: 10,
                            time_risk_factor: 5,
                            pattern_match_score: 85,
                            ml_confidence_score: 92
                        }
                    })
                });
                
                const proof = await proofResp.json();
                log('‚úÖ Session ID: ' + proof.sessionId);
                
                // Step 2: On-chain Verification
                log('\nSTEP 2: On-chain verification...');
                const verifyResp = await fetch('http://localhost:3003/zkml/verify', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        sessionId: proof.sessionId,
                        proof: {
                            proof: [123, 456, 789, 101112, 131415, 161718, 192021, 222324, 252627],
                            publicInputs: [3, 10, 1, 5]
                        },
                        inputs: [3, 10, 1, 5],
                        network: 'sepolia',
                        useRealChain: true
                    })
                });
                
                const verification = await verifyResp.json();
                log('‚úÖ TX: ' + verification.txHash);
                log('üîó https://sepolia.etherscan.io/tx/' + verification.txHash);
                
                // Step 3: Gateway Transfer with Real Signing
                log('\nSTEP 3: Gateway Transfer with REAL Signature...');
                
                const privateKey = '0xc3d22f444c7fb8339d3b16ed642e5297059a694437d7effd22d55ea5e60dc9ab';
                const wallet = new ethers.Wallet(privateKey);
                log('Wallet: ' + wallet.address);
                
                // Helper function
                const toBytes32 = (addr) => {
                    const cleaned = addr.toLowerCase().replace('0x', '');
                    return '0x' + cleaned.padStart(64, '0');
                };
                
                // Create burn intent
                const burnIntent = {
                    maxBlockHeight: "115792089237316195423570985008687907853269984665640564039457584007913129639935",
                    maxFee: "2000001",
                    spec: {
                        version: 1,
                        sourceDomain: 0,
                        destinationDomain: 6,
                        sourceContract: toBytes32('0x0077777d7EBA4688BDeF3E311b846F25870A19B9'),
                        destinationContract: toBytes32('0x0022222ABE238Cc2C7Bb1f21003F0a260052475B'),
                        sourceToken: toBytes32('0x1c7D4B196Cb0C7B01d743Fbc6116a902379C7238'),
                        destinationToken: toBytes32('0x036CbD53842c5426634e7929541eC2318f3dCF7e'),
                        sourceDepositor: toBytes32(wallet.address),
                        destinationRecipient: toBytes32('0x742d35Cc6634C0532925a3b844Bc9e7595f0bEb'),
                        sourceSigner: toBytes32(wallet.address),
                        destinationCaller: toBytes32('0x0000000000000000000000000000000000000000'),
                        value: "10000",
                        salt: toBytes32('0x' + Math.floor(Math.random() * Number.MAX_SAFE_INTEGER).toString(16).padStart(64, '0')),
                        hookData: "0x"
                    }
                };
                
                // EIP-712 signing
                const domain = {
                    name: "GatewayWallet",
                    version: "1"
                };
                
                const types = {
                    BurnIntent: [
                        { name: "maxBlockHeight", type: "uint256" },
                        { name: "maxFee", type: "uint256" },
                        { name: "spec", type: "TransferSpec" }
                    ],
                    TransferSpec: [
                        { name: "version", type: "uint32" },
                        { name: "sourceDomain", type: "uint32" },
                        { name: "destinationDomain", type: "uint32" },
                        { name: "sourceContract", type: "bytes32" },
                        { name: "destinationContract", type: "bytes32" },
                        { name: "sourceToken", type: "bytes32" },
                        { name: "destinationToken", type: "bytes32" },
                        { name: "sourceDepositor", type: "bytes32" },
                        { name: "destinationRecipient", type: "bytes32" },
                        { name: "sourceSigner", type: "bytes32" },
                        { name: "destinationCaller", type: "bytes32" },
                        { name: "value", type: "uint256" },
                        { name: "salt", type: "bytes32" },
                        { name: "hookData", type: "bytes" }
                    ]
                };
                
                const message = {
                    maxBlockHeight: ethers.BigNumber.from(burnIntent.maxBlockHeight),
                    maxFee: ethers.BigNumber.from(burnIntent.maxFee),
                    spec: burnIntent.spec
                };
                
                log('Signing EIP-712 message...');
                const signature = await wallet._signTypedData(domain, types, message);
                log('Signature: ' + signature.substring(0, 20) + '...');
                
                // Submit to Gateway
                const response = await fetch('https://gateway-api-testnet.circle.com/v1/transfer', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer SAND_API_KEY:3dc2c2b70ae5bd1943212a8521638b3b:8bb8eebdb457b04f261990e34c49d838',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify([{
                        burnIntent: burnIntent,
                        signature: signature
                    }])
                });
                
                if (response.ok) {
                    const result = await response.json();
                    log('\n‚úÖ GATEWAY TRANSFER SUCCESSFUL!');
                    log('Transfer ID: ' + (result.transferId || result.id));
                    log('Attestation: ' + (result.attestation ? result.attestation.substring(0, 50) + '...' : 'N/A'));
                } else {
                    const error = await response.text();
                    log('\n‚ùå Gateway Transfer Failed');
                    log('Error: ' + error.substring(0, 200));
                }
                
            } catch (error) {
                log('ERROR: ' + error.message);
            }
            
            log('\n===========================================');
            log('Test Complete');
        }
    </script>
</body>
</html>