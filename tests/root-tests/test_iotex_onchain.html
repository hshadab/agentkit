<!DOCTYPE html>
<html>
<head>
    <title>IoTeX On-Chain Verification Test</title>
    <script src="https://cdn.ethers.io/lib/ethers-5.7.2.umd.min.js"></script>
    <style>
        body {
            background-color: #1a1a1a;
            color: #fff;
            font-family: Arial, sans-serif;
            padding: 20px;
            max-width: 1000px;
            margin: 0 auto;
        }
        .test-section {
            background: #2a2a2a;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }
        .status {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            font-family: monospace;
        }
        .success { background: rgba(81, 207, 102, 0.2); color: #51cf66; }
        .error { background: rgba(255, 107, 107, 0.2); color: #ff6b6b; }
        .info { background: rgba(116, 192, 252, 0.2); color: #74c0fc; }
        .warning { background: rgba(255, 193, 7, 0.2); color: #ffc107; }
        button {
            background: #7c3aed;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
        }
        button:hover {
            background: #6d28d9;
        }
        button:disabled {
            background: #555;
            cursor: not-allowed;
        }
        pre {
            background: #333;
            padding: 10px;
            border-radius: 5px;
            overflow-x: auto;
            font-size: 12px;
        }
        .step {
            margin: 15px 0;
            padding: 15px;
            background: #333;
            border-radius: 5px;
            border-left: 3px solid #7c3aed;
        }
    </style>
</head>
<body>
    <h1>üîß IoTeX On-Chain Verification Test</h1>
    
    <div class="test-section">
        <h2>Prerequisites Check</h2>
        <button onclick="checkPrerequisites()">Check All Prerequisites</button>
        <div id="prereq-status"></div>
    </div>
    
    <div class="test-section">
        <h2>Test 1: Manual Verification Test</h2>
        <p>This test will attempt to verify a mock proof directly on IoTeX</p>
        <button onclick="testManualVerification()">Run Manual Test</button>
        <div id="manual-test-status"></div>
    </div>
    
    <div class="test-section">
        <h2>Test 2: Full Workflow Test</h2>
        <p>This test will generate a real proof and verify it through the complete workflow</p>
        <button onclick="testFullWorkflow()">Run Full Workflow Test</button>
        <div id="workflow-test-status"></div>
    </div>
    
    <div class="test-section">
        <h2>Test 3: Device Registration</h2>
        <p>Test device registration on IoTeX</p>
        <button onclick="testDeviceRegistration()">Test Device Registration</button>
        <div id="registration-status"></div>
    </div>
    
    <div class="test-section">
        <h2>Results Summary</h2>
        <div id="results-summary"></div>
    </div>

    <script>
        let provider = null;
        let signer = null;
        const contractAddress = '0x5967d15c7a6fD3ef7F1f309e766f35252a9de10d';
        
        async function checkPrerequisites() {
            const statusDiv = document.getElementById('prereq-status');
            statusDiv.innerHTML = '<div class="info">Checking prerequisites...</div>';
            
            let checks = [];
            
            // Check 1: MetaMask
            if (typeof window.ethereum !== 'undefined') {
                checks.push('<div class="success">‚úÖ MetaMask detected</div>');
                
                try {
                    // Check 2: Connection
                    await window.ethereum.request({ method: 'eth_requestAccounts' });
                    provider = new ethers.providers.Web3Provider(window.ethereum);
                    signer = provider.getSigner();
                    checks.push('<div class="success">‚úÖ MetaMask connected</div>');
                    
                    // Check 3: Network
                    const network = await provider.getNetwork();
                    if (network.chainId === 4690) {
                        checks.push('<div class="success">‚úÖ Connected to IoTeX Testnet</div>');
                    } else {
                        checks.push('<div class="error">‚ùå Wrong network (Chain ID: ' + network.chainId + '). Please switch to IoTeX Testnet (4690)</div>');
                        
                        // Try to switch network
                        try {
                            await window.ethereum.request({
                                method: 'wallet_switchEthereumChain',
                                params: [{ chainId: '0x1252' }] // 4690 in hex
                            });
                        } catch (switchError) {
                            if (switchError.code === 4902) {
                                // Network not added, add it
                                await window.ethereum.request({
                                    method: 'wallet_addEthereumChain',
                                    params: [{
                                        chainId: '0x1252',
                                        chainName: 'IoTeX Testnet',
                                        nativeCurrency: {
                                            name: 'IOTX',
                                            symbol: 'IOTX',
                                            decimals: 18
                                        },
                                        rpcUrls: ['https://babel-api.testnet.iotex.io'],
                                        blockExplorerUrls: ['https://testnet.iotexscan.io']
                                    }]
                                });
                            }
                        }
                    }
                    
                    // Check 4: Balance
                    const address = await signer.getAddress();
                    const balance = await provider.getBalance(address);
                    const balanceInIOTX = ethers.utils.formatEther(balance);
                    checks.push(`<div class="${parseFloat(balanceInIOTX) > 0.01 ? 'success' : 'warning'}">üí∞ Balance: ${balanceInIOTX} IOTX</div>`);
                    
                    // Check 5: Contract
                    const code = await provider.getCode(contractAddress);
                    if (code !== '0x') {
                        checks.push('<div class="success">‚úÖ Verifier contract deployed</div>');
                    } else {
                        checks.push('<div class="error">‚ùå Verifier contract not found</div>');
                    }
                    
                } catch (error) {
                    checks.push(`<div class="error">‚ùå Error: ${error.message}</div>`);
                }
            } else {
                checks.push('<div class="error">‚ùå MetaMask not detected. Please install MetaMask.</div>');
            }
            
            statusDiv.innerHTML = checks.join('');
        }
        
        async function testManualVerification() {
            const statusDiv = document.getElementById('manual-test-status');
            statusDiv.innerHTML = '<div class="info">Starting manual verification test...</div>';
            
            try {
                if (!signer) {
                    await checkPrerequisites();
                }
                
                // Contract ABI for IoTeX verifier
                const abi = [{
                    "inputs": [
                        {"internalType": "uint256[3]", "name": "i_z0_zi", "type": "uint256[3]"},
                        {"internalType": "uint256[4]", "name": "U_i_cmW_U_i_cmE", "type": "uint256[4]"},
                        {"internalType": "uint256[2]", "name": "u_i_cmW", "type": "uint256[2]"},
                        {"internalType": "uint256[3]", "name": "cmT_r", "type": "uint256[3]"},
                        {"internalType": "uint256[2]", "name": "pA", "type": "uint256[2]"},
                        {"internalType": "uint256[2][2]", "name": "pB", "type": "uint256[2][2]"},
                        {"internalType": "uint256[2]", "name": "pC", "type": "uint256[2]"},
                        {"internalType": "uint256[4]", "name": "challenge_W_challenge_E_kzg_evals", "type": "uint256[4]"},
                        {"internalType": "uint256[2][2]", "name": "kzg_proof", "type": "uint256[2][2]"},
                        {"internalType": "bytes32", "name": "deviceId", "type": "bytes32"},
                        {"internalType": "uint256", "name": "proofId", "type": "uint256"}
                    ],
                    "name": "verifyDeviceProximity",
                    "outputs": [{"internalType": "bool", "name": "", "type": "bool"}],
                    "stateMutability": "nonpayable",
                    "type": "function"
                }];
                
                const contract = new ethers.Contract(contractAddress, abi, signer);
                
                // Create mock proof data (this will fail verification but tests the contract)
                const mockProof = {
                    i_z0_zi: ["1", "2", "3"],
                    U_i_cmW_U_i_cmE: ["4", "5", "6", "7"],
                    u_i_cmW: ["8", "9"],
                    cmT_r: ["10", "11", "12"],
                    pA: ["13", "14"],
                    pB: [["15", "16"], ["17", "18"]],
                    pC: ["19", "20"],
                    challenge_W_challenge_E_kzg_evals: ["21", "22", "23", "24"],
                    kzg_proof: [["25", "26"], ["27", "28"]]
                };
                
                const deviceId = ethers.utils.id("TEST_DEVICE_" + Date.now());
                const proofId = Math.floor(Date.now() / 1000);
                
                statusDiv.innerHTML += '<div class="info">Sending verification transaction...</div>';
                statusDiv.innerHTML += `<div class="info">Device ID: ${deviceId}</div>`;
                statusDiv.innerHTML += `<div class="info">Proof ID: ${proofId}</div>`;
                
                try {
                    // First try a static call to see if it would revert
                    const result = await contract.callStatic.verifyDeviceProximity(
                        mockProof.i_z0_zi,
                        mockProof.U_i_cmW_U_i_cmE,
                        mockProof.u_i_cmW,
                        mockProof.cmT_r,
                        mockProof.pA,
                        mockProof.pB,
                        mockProof.pC,
                        mockProof.challenge_W_challenge_E_kzg_evals,
                        mockProof.kzg_proof,
                        deviceId,
                        proofId
                    );
                    
                    statusDiv.innerHTML += `<div class="info">Static call result: ${result}</div>`;
                    
                } catch (error) {
                    statusDiv.innerHTML += `<div class="warning">Static call failed (expected with mock proof): ${error.reason || error.message}</div>`;
                    statusDiv.innerHTML += '<div class="info">This is normal - mock proofs should fail cryptographic verification</div>';
                }
                
                // Show gas estimate
                try {
                    const gasEstimate = await contract.estimateGas.verifyDeviceProximity(
                        mockProof.i_z0_zi,
                        mockProof.U_i_cmW_U_i_cmE,
                        mockProof.u_i_cmW,
                        mockProof.cmT_r,
                        mockProof.pA,
                        mockProof.pB,
                        mockProof.pC,
                        mockProof.challenge_W_challenge_E_kzg_evals,
                        mockProof.kzg_proof,
                        deviceId,
                        proofId
                    );
                    
                    statusDiv.innerHTML += `<div class="info">Estimated gas: ${gasEstimate.toString()}</div>`;
                } catch (error) {
                    statusDiv.innerHTML += `<div class="info">Gas estimation failed: ${error.message}</div>`;
                }
                
                statusDiv.innerHTML += '<div class="success">‚úÖ Contract is accessible and responding</div>';
                
            } catch (error) {
                statusDiv.innerHTML += `<div class="error">‚ùå Error: ${error.message}</div>`;
            }
        }
        
        async function testFullWorkflow() {
            const statusDiv = document.getElementById('workflow-test-status');
            statusDiv.innerHTML = '<div class="info">Starting full workflow test...</div>';
            
            try {
                // Connect to WebSocket
                const ws = new WebSocket('ws://localhost:8001/ws');
                
                await new Promise((resolve, reject) => {
                    ws.onopen = () => {
                        statusDiv.innerHTML += '<div class="success">‚úÖ WebSocket connected</div>';
                        resolve();
                    };
                    ws.onerror = reject;
                });
                
                // Listen for messages
                ws.onmessage = (event) => {
                    const msg = JSON.parse(event.data);
                    statusDiv.innerHTML += `<div class="info">üì® ${msg.type}: ${msg.status || msg.message || 'received'}</div>`;
                };
                
                // Send chat request
                const response = await fetch('http://localhost:8002/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: "Generate device proximity proof for IoT device WEBTEST123 at coordinates x=5555, y=6666 and verify on IoTeX"
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    statusDiv.innerHTML += '<div class="success">‚úÖ Workflow created successfully</div>';
                    statusDiv.innerHTML += `<div class="info">Please check the main UI at http://localhost:8001 for verification status</div>`;
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                // Close WebSocket after a delay
                setTimeout(() => ws.close(), 10000);
                
            } catch (error) {
                statusDiv.innerHTML += `<div class="error">‚ùå Error: ${error.message}</div>`;
            }
        }
        
        async function testDeviceRegistration() {
            const statusDiv = document.getElementById('registration-status');
            statusDiv.innerHTML = '<div class="info">Testing device registration...</div>';
            
            try {
                if (!signer) {
                    await checkPrerequisites();
                }
                
                const abi = [
                    "function registerDevice(bytes32 deviceId) external",
                    "function getDeviceInfo(bytes32 deviceId) view returns (bool registered, address owner, uint256 registrationTime, uint256 lastProofTime, uint256 pendingRewards)"
                ];
                
                const contract = new ethers.Contract(contractAddress, abi, signer);
                const deviceId = ethers.utils.id("REG_TEST_" + Date.now());
                
                // Check if already registered
                const info = await contract.getDeviceInfo(deviceId);
                statusDiv.innerHTML += `<div class="info">Device registered: ${info.registered}</div>`;
                
                if (!info.registered) {
                    statusDiv.innerHTML += '<div class="info">Registering device...</div>';
                    
                    try {
                        const tx = await contract.registerDevice(deviceId);
                        statusDiv.innerHTML += `<div class="info">Transaction sent: ${tx.hash}</div>`;
                        
                        const receipt = await tx.wait();
                        statusDiv.innerHTML += '<div class="success">‚úÖ Device registered successfully!</div>';
                        statusDiv.innerHTML += `<div class="info">Gas used: ${receipt.gasUsed.toString()}</div>`;
                        
                    } catch (error) {
                        statusDiv.innerHTML += `<div class="error">‚ùå Registration failed: ${error.message}</div>`;
                    }
                } else {
                    statusDiv.innerHTML += '<div class="info">Device already registered</div>';
                    statusDiv.innerHTML += `<div class="info">Owner: ${info.owner}</div>`;
                    statusDiv.innerHTML += `<div class="info">Pending rewards: ${ethers.utils.formatEther(info.pendingRewards)} IOTX</div>`;
                }
                
            } catch (error) {
                statusDiv.innerHTML += `<div class="error">‚ùå Error: ${error.message}</div>`;
            }
        }
        
        // Auto-check prerequisites on load
        window.addEventListener('load', () => {
            setTimeout(checkPrerequisites, 1000);
        });
    </script>
</body>
</html>