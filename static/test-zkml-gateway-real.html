<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>zkML Gateway - Real On-Chain Verification Test</title>
    <style>
        body {
            font-family: 'Consolas', 'Monaco', monospace;
            background: #0a0a0a;
            color: #e0e0e0;
            padding: 20px;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 30px;
            text-align: center;
        }
        
        .header h1 {
            margin: 0;
            font-size: 32px;
            color: white;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .header p {
            margin: 10px 0 0 0;
            color: rgba(255,255,255,0.9);
            font-size: 14px;
        }
        
        .contract-info {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid rgba(16, 185, 129, 0.3);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .contract-info h3 {
            margin: 0 0 10px 0;
            color: #10b981;
        }
        
        .contract-address {
            font-family: monospace;
            background: rgba(0,0,0,0.3);
            padding: 8px;
            border-radius: 4px;
            word-break: break-all;
        }
        
        .controls {
            background: rgba(30, 30, 30, 0.8);
            border: 1px solid #333;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .control-group {
            margin-bottom: 15px;
        }
        
        .control-group label {
            display: block;
            margin-bottom: 5px;
            color: #8b9aff;
            font-weight: 600;
        }
        
        .control-group input, .control-group select {
            width: 100%;
            padding: 8px;
            background: rgba(0,0,0,0.5);
            border: 1px solid #444;
            border-radius: 4px;
            color: white;
            font-family: monospace;
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }
        
        .btn-success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }
        
        .workflow-container {
            background: rgba(30, 30, 30, 0.8);
            border: 1px solid #333;
            border-radius: 8px;
            padding: 20px;
            margin-top: 30px;
        }
        
        .step {
            background: rgba(0,0,0,0.3);
            border: 1px solid #444;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            transition: all 0.3s ease;
        }
        
        .step.active {
            border-color: #fbbf24;
            background: rgba(251, 191, 36, 0.1);
        }
        
        .step.completed {
            border-color: #10b981;
            background: rgba(16, 185, 129, 0.1);
        }
        
        .step-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .step-title {
            font-weight: 600;
            color: #8b9aff;
        }
        
        .step-status {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
        }
        
        .status-pending {
            background: rgba(107, 114, 128, 0.2);
            color: #9ca3af;
        }
        
        .status-active {
            background: rgba(251, 191, 36, 0.2);
            color: #fbbf24;
        }
        
        .status-completed {
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
        }
        
        .step-content {
            color: #d1d5db;
            font-size: 14px;
        }
        
        .tx-link {
            display: inline-block;
            margin-top: 10px;
            padding: 6px 12px;
            background: rgba(139, 154, 255, 0.1);
            border: 1px solid rgba(139, 154, 255, 0.3);
            color: #8b9aff;
            text-decoration: none;
            border-radius: 4px;
            font-size: 12px;
            transition: all 0.2s ease;
        }
        
        .tx-link:hover {
            background: rgba(139, 154, 255, 0.2);
            transform: translateY(-1px);
        }
        
        .log-container {
            background: #000;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
            max-height: 400px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
        
        .log-entry {
            margin-bottom: 8px;
            padding: 4px;
            border-left: 3px solid transparent;
        }
        
        .log-info {
            border-left-color: #3b82f6;
            color: #93bbfc;
        }
        
        .log-success {
            border-left-color: #10b981;
            color: #34d399;
        }
        
        .log-error {
            border-left-color: #ef4444;
            color: #f87171;
        }
        
        .log-warning {
            border-left-color: #fbbf24;
            color: #fcd34d;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîê zkML Gateway with Real Nova Verification</h1>
            <p>Test the complete workflow with on-chain proof verification on Ethereum Sepolia</p>
        </div>
        
        <div class="contract-info">
            <h3>üìã Deployed Contract</h3>
            <div class="contract-address">
                <strong>RealZKMLNovaVerifier:</strong> 0x70928d56Ee88CA586cBE2Ee4cF97Ae2fcc2cA944
            </div>
            <div style="margin-top: 10px;">
                <a href="https://sepolia.etherscan.io/address/0x70928d56Ee88CA586cBE2Ee4cF97Ae2fcc2cA944" 
                   target="_blank" class="tx-link">
                    üîç View on Etherscan
                </a>
            </div>
        </div>
        
        <div class="controls">
            <h3>‚öôÔ∏è Test Configuration</h3>
            
            <div class="control-group">
                <label>Agent Type</label>
                <select id="agentType">
                    <option value="3">Cross-Chain Agent (Type 3) - Usually Allowed</option>
                    <option value="2">Trading Agent (Type 2) - Conditional</option>
                    <option value="1">Basic Agent (Type 1) - Limited</option>
                    <option value="0">Unknown Agent (Type 0) - Always Denied</option>
                </select>
            </div>
            
            <div class="control-group">
                <label>Amount (% of available balance)</label>
                <input type="number" id="amount" value="10" min="0" max="100">
            </div>
            
            <div class="control-group">
                <label>Risk Score (0-100)</label>
                <input type="number" id="riskScore" value="5" min="0" max="100">
            </div>
            
            <div class="control-group">
                <label>Verification Mode</label>
                <select id="verificationMode">
                    <option value="real">Real On-Chain (Uses Gas)</option>
                    <option value="simulated">Simulated (No Gas)</option>
                </select>
            </div>
            
            <div class="button-group">
                <button class="btn btn-primary" onclick="runFullWorkflow()">
                    üöÄ Run Full zkML Gateway Workflow
                </button>
                <button class="btn btn-secondary" onclick="testProofGeneration()">
                    üß™ Test Proof Generation Only
                </button>
                <button class="btn btn-success" onclick="clearLogs()">
                    üóëÔ∏è Clear Logs
                </button>
            </div>
        </div>
        
        <div class="workflow-container" id="workflowContainer" style="display: none;">
            <h3>üìä Workflow Progress</h3>
            
            <div class="step" id="step1">
                <div class="step-header">
                    <div class="step-title">Step 1: zkML Inference Proof Generation</div>
                    <div class="step-status status-pending" id="step1-status">PENDING</div>
                </div>
                <div class="step-content" id="step1-content">
                    Generate JOLT-Atlas proof of ML model execution
                </div>
            </div>
            
            <div class="step" id="step2">
                <div class="step-header">
                    <div class="step-title">Step 2: On-Chain Nova Verification</div>
                    <div class="step-status status-pending" id="step2-status">PENDING</div>
                </div>
                <div class="step-content" id="step2-content">
                    Verify zkML proof on Ethereum Sepolia
                </div>
            </div>
            
            <div class="step" id="step3">
                <div class="step-header">
                    <div class="step-title">Step 3: Gateway Multi-Chain Transfer</div>
                    <div class="step-status status-pending" id="step3-status">PENDING</div>
                </div>
                <div class="step-content" id="step3-content">
                    Execute authorized USDC transfers across chains
                </div>
            </div>
        </div>
        
        <div class="log-container" id="logContainer">
            <div class="log-entry log-info">üîß System ready. Configure parameters and click "Run Full zkML Gateway Workflow"</div>
        </div>
    </div>
    
    <script>
        const BACKEND_URL = 'http://localhost:3003';
        
        function log(message, type = 'info') {
            const logContainer = document.getElementById('logContainer');
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logContainer.appendChild(entry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }
        
        function clearLogs() {
            document.getElementById('logContainer').innerHTML = '';
            log('Logs cleared', 'info');
        }
        
        function updateStep(stepNum, status, content = null) {
            const step = document.getElementById(`step${stepNum}`);
            const statusEl = document.getElementById(`step${stepNum}-status`);
            const contentEl = document.getElementById(`step${stepNum}-content`);
            
            // Update status
            step.className = 'step';
            statusEl.className = 'step-status';
            
            if (status === 'active') {
                step.classList.add('active');
                statusEl.classList.add('status-active');
                statusEl.textContent = 'IN PROGRESS';
            } else if (status === 'completed') {
                step.classList.add('completed');
                statusEl.classList.add('status-completed');
                statusEl.textContent = 'COMPLETED';
            } else {
                statusEl.classList.add('status-pending');
                statusEl.textContent = 'PENDING';
            }
            
            // Update content if provided
            if (content) {
                contentEl.innerHTML = content;
            }
        }
        
        async function runFullWorkflow() {
            const agentType = parseInt(document.getElementById('agentType').value);
            const amount = parseInt(document.getElementById('amount').value);
            const riskScore = parseInt(document.getElementById('riskScore').value);
            const useRealChain = document.getElementById('verificationMode').value === 'real';
            
            log('üöÄ Starting zkML Gateway Workflow', 'info');
            log(`Configuration: Agent=${agentType}, Amount=${amount}%, Risk=${riskScore}`, 'info');
            log(`Verification Mode: ${useRealChain ? 'Real On-Chain' : 'Simulated'}`, 'warning');
            
            document.getElementById('workflowContainer').style.display = 'block';
            
            try {
                // Step 1: Generate zkML Proof
                updateStep(1, 'active');
                log('ü§ñ Step 1: Generating zkML proof with JOLT-Atlas...', 'info');
                
                const proofResponse = await fetch(`${BACKEND_URL}/zkml/prove`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        agentId: 'test_agent_001',
                        agentType: agentType === 3 ? 'cross_chain' : 'basic',
                        amount: amount,
                        operation: 'gateway_transfer',
                        riskScore: riskScore / 100
                    })
                });
                
                const { sessionId } = await proofResponse.json();
                log(`Proof generation started, session: ${sessionId}`, 'info');
                
                // Wait for proof generation
                await new Promise(resolve => setTimeout(resolve, 3000));
                
                updateStep(1, 'completed', '‚úÖ zkML proof generated successfully');
                log('‚úÖ Step 1 completed: Proof generated', 'success');
                
                // Step 2: On-Chain Verification
                updateStep(2, 'active');
                log('üîó Step 2: Verifying proof on Ethereum Sepolia...', 'info');
                
                if (useRealChain) {
                    log('‚ö†Ô∏è Using real on-chain verification (will consume gas)', 'warning');
                }
                
                const verifyResponse = await fetch(`${BACKEND_URL}/zkml/verify`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        sessionId,
                        proof: { inputs: [agentType, amount, 1, riskScore] },
                        network: 'sepolia',
                        useRealChain: useRealChain,
                        inputs: [agentType, amount, 1, riskScore]
                    })
                });
                
                const verification = await verifyResponse.json();
                
                if (verification.verified) {
                    const txLink = verification.txHash ? 
                        `<a href="https://sepolia.etherscan.io/tx/${verification.txHash}" target="_blank" class="tx-link">
                            üîó View Transaction on Etherscan
                        </a>` : '';
                    
                    updateStep(2, 'completed', 
                        `‚úÖ Proof verified on-chain<br>
                         Decision: ${verification.authorized ? 'AUTHORIZED' : 'DENIED'}<br>
                         ${verification.txHash ? `Transaction: ${verification.txHash.slice(0, 10)}...` : ''}<br>
                         ${txLink}`
                    );
                    
                    log(`‚úÖ Step 2 completed: Proof verified (${verification.authorized ? 'AUTHORIZED' : 'DENIED'})`, 'success');
                    
                    if (verification.txHash) {
                        log(`Transaction hash: ${verification.txHash}`, 'info');
                        log(`View on Etherscan: https://sepolia.etherscan.io/tx/${verification.txHash}`, 'info');
                    }
                    
                    if (verification.authorized) {
                        // Step 3: Gateway Transfer (simulated)
                        updateStep(3, 'active');
                        log('üí∏ Step 3: Executing multi-chain Gateway transfers...', 'info');
                        
                        await new Promise(resolve => setTimeout(resolve, 2000));
                        
                        updateStep(3, 'completed', 
                            `‚úÖ Gateway transfers completed<br>
                             - Ethereum Sepolia: 0.01 USDC<br>
                             - Base Sepolia: 0.01 USDC<br>
                             - Avalanche Fuji: 0.01 USDC`
                        );
                        
                        log('‚úÖ Step 3 completed: Multi-chain transfers executed', 'success');
                        log('üéâ Workflow completed successfully!', 'success');
                    } else {
                        updateStep(3, 'pending', 'Transfer not authorized - agent denied by zkML model');
                        log('‚ö†Ô∏è Step 3 skipped: Agent not authorized', 'warning');
                    }
                } else {
                    updateStep(2, 'pending', '‚ùå Verification failed');
                    log('‚ùå Step 2 failed: Proof verification failed', 'error');
                }
                
            } catch (error) {
                log(`‚ùå Error: ${error.message}`, 'error');
                console.error(error);
            }
        }
        
        async function testProofGeneration() {
            log('üß™ Testing proof generation only...', 'info');
            
            try {
                const response = await fetch(`${BACKEND_URL}/zkml/prove`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        agentId: 'test_agent',
                        agentType: 'cross_chain',
                        amount: 10,
                        operation: 'test',
                        riskScore: 0.1
                    })
                });
                
                const result = await response.json();
                log(`‚úÖ Proof generation test successful. Session: ${result.sessionId}`, 'success');
                
            } catch (error) {
                log(`‚ùå Proof generation test failed: ${error.message}`, 'error');
            }
        }
        
        // Initialize
        log('üîê zkML Gateway Test Interface Initialized', 'success');
        log(`üìã Contract: 0x70928d56Ee88CA586cBE2Ee4cF97Ae2fcc2cA944`, 'info');
        log(`üåê Network: Ethereum Sepolia`, 'info');
    </script>
</body>
</html>